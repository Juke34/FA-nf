#!/bin/bash

# MySQL containerized instance

MYSQLDIR=$1
PROCESSFILE=/path/to/process

mkdir -p $MYSQLDIR
mkdir -p $MYSQLDIR/db
mkdir -p $MYSQLDIR/socket

sudo sudo /usr/local/bin/singularity build mariadb.simg Singularity.mysql

# Create DB
singularity exec -B $MYSQLDIR/db:/var/lib/mysql -B ./mariadb-custom.cnf:/etc/mysql/conf.d/custom.cnf mariadb.simg mysql_install_db

# Execute DB
/sbin/ifconfig eth0 | perl -lane 'if ( $_=~/inet\s/ ) { $_=~/inet\s(\S+)\s/ ; print $1; }' > /path/to/mysql.ip

# mysql.ip will be dbhost
# dbuser, dbpass and dbport from config

singularity instance.start -B $MYSQLDIR/db:/var/lib/mysql -B ./mariadb-custom.cnf:/etc/mysql/conf.d/custom.cnf -B $MYSQLDIR/socket:/run/mysqld mariadb.simg mysql

# Do some work here on the DB ...

# Create $PROCESSFILE here

while true
do
	if [ -f $PROCESSFILE ];
		sleep 60
	fi
done

singularity instance.stop mysql


